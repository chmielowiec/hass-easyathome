name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: HACS validation
        continue-on-error: true
        uses: hacs/action@main
        with:
          category: integration

      - name: Hassfest validation
        uses: home-assistant/actions/hassfest@master

  release:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Read CHANGELOG
        id: changelog
        run: |
          # Extract changelog for this version
          VERSION=${{ steps.version.outputs.version }}
          sed -n "/## \[${VERSION#v}\]/,/## \[/p" CHANGELOG.md | sed '$ d' > RELEASE_NOTES.md
          # If not found, use the first section
          if [ ! -s RELEASE_NOTES.md ]; then
            sed -n '/## \[/,/## \[/p' CHANGELOG.md | head -n -1 > RELEASE_NOTES.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on release (HACS)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üè† This release is HACS compatible!\n\nInstall via HACS:\n1. Open Home Assistant Settings ‚Üí Devices & Services\n2. Click "Create Automation"\n3. Add HACS custom repository: `https://github.com/${{ github.repository }}`'
            })
